import jsPDF from 'jspdf';
import html2canvas from 'html2canvas';
import QRCode from 'qrcode';
import { LOGO_BASE64 } from './logoBase64';

/**
 * Professional Zakat Certificate Generator
 * Minimal Colors | Clean Design | International Standard
 */
export default async function generateZakatCertificate(certificateData, language = 'bn') {
  try {
    console.log('ЁЯЪА Generating PROFESSIONAL Certificate...');
    
    await document.fonts.ready;
    
    const { 
      certificateId, 
      date, 
      userName = 'ржмрзНржпржмрж╣рж╛рж░ржХрж╛рж░рзА',
      assets = {},
      liabilities = {},
      result = {},
      nisabInfo = ''
    } = certificateData;

    const totalAssets = Object.values(assets).reduce((sum, val) => sum + (parseFloat(val) || 0), 0);
    const totalLiabilities = Object.values(liabilities).reduce((sum, val) => sum + (parseFloat(val) || 0), 0);
    const zakatableWealth = totalAssets - totalLiabilities;
    const nisabThreshold = result.nisabThreshold || 109207.56;
    const isZakatObligatory = result.isObligatory || false;
    const zakatAmount = result.zakatDue || 0;
    let silverPrice = 178;
    if (nisabInfo) {
      const match = nisabInfo.match(/рз│(\d+)/);
      if (match) silverPrice = parseInt(match[1]);
    }

    const localDate = new Date().toLocaleString('bn-BD', {
      dateStyle: 'full',
      timeStyle: 'short',
      timeZone: Intl.DateTimeFormat().resolvedOptions().timeZone
    });

    const getCountryGoldSource = () => {
      const userCountry = certificateData.userCountry || 'BD';
      const sources = {
        'BD': { flag: 'ЁЯЗзЁЯЗй', name: 'Bangladesh', org: 'BAJUS', url: 'www.bajus.org' },
        'IN': { flag: 'ЁЯЗоЁЯЗ│', name: 'India', org: 'IBJA', url: 'www.ibja.co' },
        'PK': { flag: 'ЁЯЗ╡ЁЯЗ░', name: 'Pakistan', org: 'Sarafa', url: 'Local Sarafa' },
        'TR': { flag: 'ЁЯЗ╣ЁЯЗ╖', name: 'Turkey', org: 'Turkish Jewellers', url: 'Local' },
        'MY': { flag: 'ЁЯЗ▓ЁЯЗ╛', name: 'Malaysia', org: 'Malaysian Gold', url: 'Local' },
        'ID': { flag: 'ЁЯЗоЁЯЗй', name: 'Indonesia', org: 'Indonesian Gold', url: 'Local' },
        'SA': { flag: 'ЁЯЗ╕ЁЯЗж', name: 'Saudi Arabia', org: 'Saudi Gold', url: 'Local' },
        'AE': { flag: 'ЁЯЗжЁЯЗк', name: 'UAE', org: 'Dubai Gold', url: 'Dubai souk' },
        'US': { flag: 'ЁЯЗ║ЁЯЗ╕', name: 'USA', org: 'US Mint', url: 'usmint.gov' },
        'GB': { flag: 'ЁЯЗмЁЯЗз', name: 'UK', org: 'UK Dealers', url: 'Local' }
      };
      return sources[userCountry] || sources['BD'];
    };

    const countrySource = getCountryGoldSource();

    const certQRCode = await QRCode.toDataURL(`https://muslim-finance-tracker.vercel.app/verify/${certificateId}`, {
      width: 180, margin: 2, color: { dark: '#000000', light: '#ffffff' }
    });
    
    const appQRCode = await QRCode.toDataURL('https://muslim-finance-tracker.vercel.app', {
      width: 90, margin: 1, color: { dark: '#000000', light: '#ffffff' }
    });

    // Professional page creator with PROPER CONTENT LIMITING (NO OVERFLOW!)
    const createPage = (content, pageNum, total) => {
      const container = document.createElement('div');
      container.style.cssText = `
        position: fixed; left: -10000px; top: 0;
        width: 794px; height: 1123px; background: white;
        font-family: 'Noto Sans Bengali', 'Hind Siliguri', Arial, sans-serif;
        padding: 0; margin: 0; box-sizing: border-box;
      `;
      
      container.innerHTML = `
        <!-- HEADER: 110px with BIGGER LEFT LOGO -->
        <div style="height: 110px; background: linear-gradient(135deg, #16a34a, #15803d); padding: 20px 35px; box-shadow: 0 2px 8px rgba(22, 163, 74, 0.3);">
          <div style="display: flex; align-items: center; justify-content: flex-start; gap: 25px; height: 100%;">
            <img src="${LOGO_BASE64}" style="width: 90px; height: 90px; filter: brightness(0) invert(1);" />
            <div>
              <div style="font-size: 32px; font-weight: 800; color: white; letter-spacing: -0.8px; line-height: 1.1;">ржпрж╛ржХрж╛ржд рж╣рж┐рж╕рж╛ржм рж╕ржиржжржкрждрзНрж░</div>
              <div style="font-size: 16px; color: rgba(255,255,255,0.95); font-weight: 500; margin-top: 6px;">Zakat Calculation Certificate</div>
            </div>
          </div>
        </div>
        
        <!-- CONTENT AREA: 860px SAFE ZONE -->
        <div style="height: 860px; padding: 13px 35px 25px 35px; overflow: hidden; box-sizing: border-box;">
          <div style="max-height: 819px; overflow: hidden;">
            ${content}
          </div>
        </div>
        
        <!-- FOOTER: 103px - ALWAYS AT BOTTOM -->
        <div style="height: 103px; padding: 15px 35px 20px 35px; border-top: 2px solid #e5e7eb; background: white; box-sizing: border-box;">
          <div style="display: flex; justify-content: space-between; align-items: center; height: 100%;">
            <div style="display: flex; align-items: center; gap: 12px;">
              <img src="${appQRCode}" style="width: 50px; height: 50px; border: 2px solid #16a34a; border-radius: 6px; padding: 4px; background: white;" />
              <div style="font-size: 9px; color: #666;">
                <div style="font-weight: 700; color: #16a34a; font-size: 10px; margin-bottom: 2px;">ржорзБрж╕рж▓рж┐ржо ржлрж┐ржирзНржпрж╛ржирзНрж╕ ржЯрзНрж░рзНржпрж╛ржХрж╛рж░</div>
                <div style="margin-bottom: 1px;">ржЕрзНржпрж╛ржк ржжрзЗржЦрждрзЗ рж╕рзНржХрзНржпрж╛ржи ржХрж░рзБржи</div>
                <div style="color: #16a34a; font-weight: 600;">muslim-finance-tracker.vercel.app</div>
              </div>
            </div>
            <div style="text-align: right; font-size: 8px; color: #666;">
              <div style="font-weight: 600; margin-bottom: 2px;">┬й рзирзжрзирзл ржорзБрж╕рж▓рж┐ржо ржлрж┐ржирзНржпрж╛ржирзНрж╕ ржЯрзНрж░рзНржпрж╛ржХрж╛рж░ред рж╕рж░рзНржмрж╕рзНржмрждрзНржм рж╕ржВрж░ржХрзНрж╖рж┐рждред</div>
              <div style="color: #999;">ржкрзГрж╖рзНржарж╛ ${pageNum}/${total} | ${localDate}</div>
            </div>
          </div>
        </div>
      `;
      
      document.body.appendChild(container);
      return container;
    };

    const pages = [];

    // ===== PAGE 1: CLEAN PROFESSIONAL RESULT (OPTIMIZED) =====
    pages.push(`
      <!-- Certificate Info - Compact Design -->
      <div style="background: #f9fafb; border-left: 4px solid #16a34a; padding: 10px; border-radius: 5px; margin-bottom: 9px;">
        <table style="width: 100%; font-size: 10px; line-height: 1.8;">
          <tr>
            <td style="width: 50%;"><strong style="color: #374151;">рж╕ржиржж ржиржорзНржмрж░:</strong></td>
            <td style="font-family: monospace; color: #6b7280;">${certificateId}</td>
          </tr>
          <tr>
            <td><strong style="color: #374151;">ржмрзНржпржмрж╣рж╛рж░ржХрж╛рж░рзА:</strong></td>
            <td style="color: #6b7280;">${userName}</td>
          </tr>
          <tr>
            <td><strong style="color: #374151;">рждрж╛рж░рж┐ржЦ ржУ рж╕ржоржпрж╝:</strong></td>
            <td style="color: #6b7280;">${localDate}</td>
          </tr>
        </table>
      </div>

      <!-- RESULT BOX - Compact -->
      ${isZakatObligatory ? `
        <div style="background: #f0fdf4; border: 3px solid #16a34a; border-radius: 10px; padding: 18px; text-align: center; margin-bottom: 9px;">
          <div style="font-size: 44px; margin-bottom: 10px; color: #16a34a;">тЬУ</div>
          <h1 style="margin: 0 0 8px 0; font-size: 24px; font-weight: 800; color: #15803d;">
            ржорж╛рж╢рж╛ржЖрж▓рзНрж▓рж╛рж╣! ржЖржкржирж╛рж░ ржЙржкрж░ ржпрж╛ржХрж╛ржд ржлрж░ржп
          </h1>
          <div style="font-size: 12px; font-weight: 600; color: #166534; margin-bottom: 10px;">
            тШкя╕П ZAKAT IS OBLIGATORY тШкя╕П
          </div>
          <div style="background: white; border: 2px solid #16a34a; border-radius: 8px; padding: 9px; margin-top: 14px;">
            <p style="margin: 0 0 8px 0; font-size: 12px; color: #374151; font-weight: 600;">ржЖржкржирж╛рж░ ржпрж╛ржХрж╛рждрзЗрж░ ржкрж░рж┐ржорж╛ржг:</p>
            <p style="margin: 0; font-size: 32px; font-weight: 900; color: #15803d;">рз│${zakatAmount.toLocaleString('bn-BD')}</p>
            <p style="margin: 10px 0 0 0; font-size: 10px; color: #6b7280;">(ржпрж╛ржХрж╛рждржпрзЛржЧрзНржп рж╕ржорзНржкржжрзЗрж░ рзи.рзл% = рзз/рзкрзж ржЕржВрж╢)</p>
          </div>
        </div>
      ` : `
        <div style="background: #f9fafb; border: 3px solid #9ca3af; border-radius: 12px; padding: 30px; text-align: center; margin-bottom: 25px;">
          <div style="font-size: 50px; margin-bottom: 9px; color: #6b7280;">тД╣</div>
          <h1 style="margin: 0 0 10px 0; font-size: 28px; font-weight: 800; color: #374151;">ржЖржкржирж╛рж░ ржЙржкрж░ ржпрж╛ржХрж╛ржд ржлрж░ржп ржиржпрж╝</h1>
          <div style="font-size: 12px; color: #6b7280; margin-top: 10px;">Your wealth is below Nisab threshold</div>
          <div style="margin-top: 20px; padding: 15px; background: white; border-radius: 8px; font-size: 12px; color: #6b7280;">
            <strong>ржХрж╛рж░ржг:</strong> рж╕ржорзНржкржж (рз│${zakatableWealth.toLocaleString('bn-BD')}) ржирж┐рж╕рж╛ржмрзЗрж░ (рз│${nisabThreshold.toLocaleString('bn-BD')}) ржирж┐ржЪрзЗ
          </div>
        </div>
      `}

      <!-- Calculation Summary - Compact Table -->
      <div style="background: white; border: 2px solid #e5e7eb; border-radius: 6px; padding: 10px; margin-bottom: 10px;">
        <h2 style="font-size: 12px; font-weight: 700; color: #1f2937; margin: 0 0 12px 0; padding-bottom: 8px; border-bottom: 2px solid #e5e7eb; text-align: center;">
          ЁЯУК рж╣рж┐рж╕рж╛ржмрзЗрж░ рж╕рж╛рж░рж╕ржВржХрзНрж╖рзЗржк | CALCULATION SUMMARY
        </h2>
        <table style="width: 100%; border-collapse: collapse; font-size: 10px;">
          <thead>
            <tr style="background: #f3f4f6;">
              <th style="padding: 8px; border: 1px solid #e5e7eb; text-align: left; font-weight: 700; color: #374151;">рж╕ржорзНржкржжрзЗрж░ ржзрж░ржи | Asset Type</th>
              <th style="padding: 8px; border: 1px solid #e5e7eb; text-align: right; font-weight: 700; color: #374151;">ржкрж░рж┐ржорж╛ржг | Amount</th>
            </tr>
          </thead>
          <tbody>
            ${assets.cash ? `<tr><td style="padding: 8px; border: 1px solid #e5e7eb; color: #4b5563;">ржиржЧржж ржЯрж╛ржХрж╛ | Cash</td><td style="padding: 8px; border: 1px solid #e5e7eb; text-align: right; font-weight: 600; color: #1f2937;">рз│${parseFloat(assets.cash).toLocaleString('bn-BD')}</td></tr>` : ''}
            ${assets.bankBalance ? `<tr><td style="padding: 8px; border: 1px solid #e5e7eb; color: #4b5563;">ржмрзНржпрж╛ржВржХ | Bank</td><td style="padding: 8px; border: 1px solid #e5e7eb; text-align: right; font-weight: 600; color: #1f2937;">рз│${parseFloat(assets.bankBalance).toLocaleString('bn-BD')}</td></tr>` : ''}
            ${assets.goldValue ? `<tr><td style="padding: 8px; border: 1px solid #e5e7eb; color: #4b5563;">рж╕рзНржмрж░рзНржг | Gold</td><td style="padding: 8px; border: 1px solid #e5e7eb; text-align: right; font-weight: 600; color: #1f2937;">рз│${parseFloat(assets.goldValue).toLocaleString('bn-BD')}</td></tr>` : ''}
            ${assets.silverValue ? `<tr><td style="padding: 8px; border: 1px solid #e5e7eb; color: #4b5563;">рж░рзВржкрж╛ | Silver</td><td style="padding: 8px; border: 1px solid #e5e7eb; text-align: right; font-weight: 600; color: #1f2937;">рз│${parseFloat(assets.silverValue).toLocaleString('bn-BD')}</td></tr>` : ''}
            ${assets.businessInventory ? `<tr><td style="padding: 8px; border: 1px solid #e5e7eb; color: #4b5563;">ржмрзНржпржмрж╕рж╛ | Business</td><td style="padding: 8px; border: 1px solid #e5e7eb; text-align: right; font-weight: 600; color: #1f2937;">рз│${parseFloat(assets.businessInventory).toLocaleString('bn-BD')}</td></tr>` : ''}
            ${assets.investments ? `<tr><td style="padding: 8px; border: 1px solid #e5e7eb; color: #4b5563;">ржмрж┐ржирж┐ржпрж╝рзЛржЧ</td><td style="padding: 8px; border: 1px solid #e5e7eb; text-align: right; font-weight: 600; color: #1f2937;">рз│${parseFloat(assets.investments).toLocaleString('bn-BD')}</td></tr>` : ''}
            <tr style="background: #f9fafb; font-weight: 700;">
              <td style="padding: 10px; border: 2px solid #d1d5db; color: #1f2937;">ржорзЛржЯ рж╕ржорзНржкржж | Total Assets</td>
              <td style="padding: 10px; border: 2px solid #d1d5db; text-align: right; color: #1f2937;">рз│${totalAssets.toLocaleString('bn-BD')}</td>
            </tr>
            ${totalLiabilities > 0 ? `<tr style="color: #dc2626; font-weight: 600;">
              <td style="padding: 8px; border: 1px solid #fca5a5;">ржорзЛржЯ ржжрж╛ржпрж╝ | Liabilities</td>
              <td style="padding: 8px; border: 1px solid #fca5a5; text-align: right;">-рз│${totalLiabilities.toLocaleString('bn-BD')}</td>
            </tr>` : ''}
            <tr style="background: #f0fdf4; font-weight: 700;">
              <td style="padding: 10px; border: 2px solid #16a34a; color: #15803d;">ржпрж╛ржХрж╛рждржпрзЛржЧрзНржп | Zakatable</td>
              <td style="padding: 10px; border: 2px solid #16a34a; text-align: right; color: #15803d;">рз│${zakatableWealth.toLocaleString('bn-BD')}</td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- SPACING -->
      <div style="height: 12px;"></div>

      <!-- Nisab Info - Compact -->
      <div style="background: #fffbeb; border: 2px solid #fbbf24; border-radius: 6px; padding: 10px; text-align: center;">
        <h3 style="font-size: 12px; font-weight: 700; color: #92400e; margin: 0 0 10px 0;">
          ЁЯУП ржирж┐рж╕рж╛ржм рж╕рзАржорж╛ | NISAB THRESHOLD
        </h3>
        <div style="font-size: 10px; margin-bottom: 6px; color: #78350f; font-weight: 600;">рж░рзВржкрж╛ ржнрж┐рждрзНрждрж┐ржХ ржирж┐рж╕рж╛ржм | Silver-based Nisab</div>
        <div style="font-size: 24px; font-weight: 800; color: #b45309; margin-bottom: 5px;">рз│${nisabThreshold.toLocaleString('bn-BD')}</div>
        <div style="font-size: 9px; color: #78350f; line-height: 1.5;">
          (рзлрзи.рзл рждрзЛрж▓рж╛ рж░рзВржкрж╛ ├Ч рззрзз.рзмрзм ржЧрзНрж░рж╛ржо ├Ч рз│${silverPrice}/ржЧрзНрж░рж╛ржо)<br/>
          (52.5 vori silver ├Ч 11.66 gram ├Ч рз│${silverPrice}/gram)
        </div>
      </div>

      <!-- SPACING -->
      <div style="height: 20px;"></div>
    `);

    // ===== PAGE 2: METHODOLOGY =====
    pages.push(`
      <div style="background: #f9fafb; border-left: 4px solid #3b82f6; padding: 13px; border-radius: 6px; margin-bottom: 10px;">
        <h2 style="font-size: 18px; font-weight: 700; color: #1e40af; margin: 0 0 15px 0; text-align: center; padding-bottom: 10px; border-bottom: 2px solid #e5e7eb;">
          ЁЯУР рж╣рж┐рж╕рж╛ржм ржкржжрзНржзрждрж┐ | CALCULATION METHODOLOGY
        </h2>
        
        <div style="margin-bottom: 9px;">
          <div style="font-size: 12px; font-weight: 700; color: #1f2937; margin-bottom: 8px; background: white; padding: 8px; border-radius: 4px;">
            рззред ржирж┐рж╕рж╛ржм ржирж┐рж░рзНржзрж╛рж░ржг | Nisab Determination
          </div>
          <div style="background: white; padding: 10px; border-radius: 4px; border: 1px solid #e5e7eb; font-size: 10px;">
            <div style="margin-bottom: 8px;"><strong>рж╕рзВрждрзНрж░ | Formula:</strong></div>
            <div style="font-family: monospace; background: #f3f4f6; padding: 8px; border-radius: 4px; line-height: 1.7; color: #374151;">
              ржирж┐рж╕рж╛ржм = рзлрзи.рзл рждрзЛрж▓рж╛ рж░рзВржкрж╛ ├Ч рззрзз.рзмрзм ржЧрзНрж░рж╛ржо/рждрзЛрж▓рж╛ ├Ч ржмрж░рзНрждржорж╛ржи рж░рзВржкрж╛рж░ ржмрж┐ржХрзНрж░ржпрж╝ ржорзВрж▓рзНржп<br/>
              Nisab = 52.5 vori silver ├Ч 11.66 gram/vori ├Ч Current silver selling price
            </div>
            <div style="margin-top: 10px; font-family: monospace; line-height: 1.9; color: #374151;">
              тЖТ рзлрзи.рзл ├Ч рззрзз.рзмрзм = рзмрззрзи.рззрзл ржЧрзНрж░рж╛ржо<br/>
              тЖТ рж░рзВржкрж╛рж░ ржорзВрж▓рзНржп: рз│${silverPrice}/ржЧрзНрж░рж╛ржо<br/>
              <div style="margin-top: 8px; padding: 8px; background: #fffbeb; border-radius: 4px; font-weight: 700; color: #b45309;">
                тЖТ ржирж┐рж╕рж╛ржм = рз│${nisabThreshold.toLocaleString('bn-BD')}
              </div>
            </div>
          </div>
        </div>

        <div style="margin-bottom: 9px;">
          <div style="font-size: 12px; font-weight: 700; color: #1f2937; margin-bottom: 8px; background: white; padding: 8px; border-radius: 4px;">
            рзиред ржХрзЗржи рж░рзВржкрж╛рж░ ржирж┐рж╕рж╛ржм? ржПржХрж╛ржзрж┐ржХ рж╕ржорзНржкржж ржорж┐рж▓рзЗ ржпрж╛ржХрж╛ржд
          </div>
          <div style="background: white; padding: 10px; border-radius: 4px; border: 1px solid #e5e7eb; font-size: 10px; line-height: 1.8; color: #374151;">
            <p style="margin: 0 0 10px 0;">рж╣рж╛ржирж╛ржлрзА ржорж╛ржпрж╣рж╛ржм ржЕржирзБрж╕рж╛рж░рзЗ рж░рзВржкрж╛рж░ ржирж┐рж╕рж╛ржм ржмрзНржпржмрж╣рж╛рж░ ржХрж░рж╛ рж╣ржпрж╝ ржХрж╛рж░ржг ржПржЯрж┐ ржЧрж░рзАржмржжрзЗрж░ ржЬржирзНржп ржЕржзрж┐ржХ ржХрж▓рзНржпрж╛ржгржХрж░ред</p>
            <div style="background: #f0fdf4; padding: 8px; border-radius: 4px; border-left: 3px solid #16a34a; font-size: 9px; color: #166534;">
              <strong>ЁЯУМ ржЧрзБрж░рзБрждрзНржмржкрзВрж░рзНржг:</strong><br/>
              тАв рзлрзи.рзл ржнрж░рж┐ рж░рзВржкрж╛ ржмрж╛ рзн.рзл ржнрж░рж┐ рж╕рзЛржирж╛ ржПржХржХ ржнрж╛ржмрзЗ ржирж╛ ржерж╛ржХрж▓рзЗржУ рж╕ржорж╕рзНржпрж╛ ржирзЗржЗ<br/>
              тАв рж╕рзЛржирж╛ + рж░рзВржкрж╛ + ржиржЧржж + ржмрзНржпржмрж╕рж╛ = рж╕ржм ржорж┐рж▓рж┐ржпрж╝рзЗ ржпржжрж┐ рзлрзи.рзл ржнрж░рж┐ рж░рзВржкрж╛рж░ ржорзВрж▓рзНржпрзЗрж░ рж╕ржорж╛ржи ржмрж╛ ржмрзЗрж╢рж┐ рж╣ржпрж╝ рждрж╛рж╣рж▓рзЗ ржпрж╛ржХрж╛ржд ржлрж░ржп<br/>
              тАв ржЙржжрж╛рж╣рж░ржг: рзирзж ржнрж░рж┐ рж░рзВржкрж╛ + рзлрзж,рзжрзжрзж ржЯрж╛ржХрж╛ + рзйрзж,рзжрзжрзж ржмрзНржпржмрж╕рж╛ = ржорж┐рж▓рж┐ржпрж╝рзЗ ржирж┐рж╕рж╛ржм рж╣рж▓рзЗ ржпрж╛ржХрж╛ржд ржжрж┐рждрзЗ рж╣ржмрзЗ
            </div>
          </div>
        </div>

        ${isZakatObligatory ? `
        <div>
          <div style="font-size: 12px; font-weight: 700; color: #1f2937; margin-bottom: 8px; background: white; padding: 8px; border-radius: 4px;">
            рзйред ржЖржкржирж╛рж░ рж╣рж┐рж╕рж╛ржм | Your Calculation
          </div>
          <div style="background: white; padding: 10px; border-radius: 4px; border: 1px solid #e5e7eb; font-size: 10px; line-height: 2; color: #374151;">
            <div>рзз. ржорзЛржЯ рж╕ржорзНржкржж = рз│${totalAssets.toLocaleString('bn-BD')}</div>
            ${totalLiabilities > 0 ? `<div>рзи. ржжрж╛ржпрж╝ = рз│${totalLiabilities.toLocaleString('bn-BD')}</div>` : ''}
            <div>${totalLiabilities > 0 ? 'рзй' : 'рзи'}. ржпрж╛ржХрж╛рждржпрзЛржЧрзНржп = рз│${zakatableWealth.toLocaleString('bn-BD')}</div>
            <div style="margin-top: 10px; padding: 8px; background: #f0fdf4; border-radius: 4px; border-left: 3px solid #16a34a; font-weight: 700; color: #15803d;">
              тЬЕ ржпрж╛ржХрж╛ржд ржлрж░ржп<br/>
              <span style="font-size: 9px; color: #166534;">рж╣рж╛рж░: рзи.рзл% = рзз/рзкрзж ржЕржВрж╢</span><br/>
              Zakat = рз│${zakatableWealth.toLocaleString('bn-BD')} ├Ч 2.5% = рз│${zakatAmount.toLocaleString('bn-BD')}
            </div>
          </div>
        </div>
        ` : ''}
      </div>

      <div style="background: white; border: 1px solid #e5e7eb; padding: 10px; border-radius: 6px;">
        <div style="font-size: 12px; font-weight: 700; color: #1f2937; margin-bottom: 10px;">ЁЯУЪ рж╕рзВрждрзНрж░ | Primary Sources</div>
        <div style="font-size: 9px; color: #6b7280; line-height: 2;">
          тАв ржжрж╛рж░рзБрж▓ ржЙрж▓рзБржо ржжрзЗржУржмржирзНржж (Darul Uloom Deoband)<br/>
          тАв ржорзБржлрждрзА рждрж╛ржХрзА ржЙрж╕ржорж╛ржирзА (Mufti Taqi Usmani)<br/>
          тАв ржЖрж▓-ржХрж╛ржЙрж╕рж╛рж░, ржмрж╛ржВрж▓рж╛ржжрзЗрж╢ (Al-Kauthar, Bangladesh)<br/>
          тАв ржлрж╛рждрж╛ржУржпрж╝рж╛ рж╢рж╛ржорзА (Fatawa Shami)
        </div>
      </div>

      <!-- SPACING -->
      <div style="height: 20px;"></div>
    `);

    // ===== PAGE 3: REFERENCES & VERIFICATION =====
    pages.push(`
      <div style="background: #f0fdf4; border: 2px solid #16a34a; padding: 9px; border-radius: 8px; margin-bottom: 9px;">
        <h2 style="font-size: 18px; font-weight: 700; color: #15803d; margin: 0 0 15px 0; text-align: center; padding-bottom: 10px; border-bottom: 2px solid #16a34a;">
          тШкя╕П ржЗрж╕рж▓рж╛ржорзА рж░рзЗржлрж╛рж░рзЗржирзНрж╕ | ISLAMIC REFERENCES
        </h2>
        
        <div style="background: white; padding: 10px; border-radius: 6px; margin-bottom: 10px; border-left: 3px solid #16a34a;">
          <div style="font-size: 12px; font-weight: 700; color: #166534; margin-bottom: 5px;">ржорж╛ржпрж╣рж╛ржм | Madhab:</div>
          <div style="font-size: 10px; color: #374151; margin-bottom: 8px;">рж╣рж╛ржирж╛ржлрзА (Hanafi)</div>
          <div style="font-size: 9px; color: #6b7280; font-style: italic; line-height: 1.6;">
            ржПржЗ рж╣рж┐рж╕рж╛ржм рж╣рж╛ржирж╛ржлрзА ржорж╛ржпрж╣рж╛ржмрзЗрж░ (рзлрзи.рзл рждрзЛрж▓рж╛ рж░рзВржкрж╛) ржирж┐ржпрж╝ржо ржЕржирзБрж╕рж░ржг ржХрж░рзЗ рждрзИрж░рж┐ред<br/>
            Silver nisab (52.5 vori) - Recommended for general public
          </div>
        </div>

        <div style="background: white; padding: 10px; border-radius: 6px; margin-bottom: 10px; border-left: 3px solid #16a34a;">
          <div style="font-size: 12px; font-weight: 700; color: #166534; margin-bottom: 5px;">ржкрзНрж░рж╛ржержорж┐ржХ рж╕рзВрждрзНрж░:</div>
          <div style="font-size: 9px; color: #6b7280; line-height: 1.9;">
            тАв ржжрж╛рж░рзБрж▓ ржЙрж▓рзБржо ржжрзЗржУржмржирзНржж<br/>
            тАв ржорзБржлрждрзА рждрж╛ржХрзА ржЙрж╕ржорж╛ржирзА<br/>
            тАв ржЖрж▓-ржХрж╛ржЙрж╕рж╛рж░, ржмрж╛ржВрж▓рж╛ржжрзЗрж╢
          </div>
        </div>

        <div style="background: white; padding: 10px; border-radius: 6px; border-left: 3px solid #16a34a; margin-bottom: 8px;">
          <div style="font-size: 10px; font-weight: 700; color: #166534; margin-bottom: 6px;">ЁЯУЦ ржкржмрж┐рждрзНрж░ ржХрзБрж░ржЖржи | Holy Quran:</div>
          <div style="font-size: 9px; color: #6b7280; line-height: 1.8;">
            <strong style="color: #15803d;">"ржЖрж░ рждрзЛржорж░рж╛ ржпрж╛ржХрж╛ржд ржкрзНрж░ржжрж╛ржи ржХрж░"</strong><br/>
            <span style="font-style: italic;">(рж╕рзВрж░рж╛ ржмрж╛ржХрж╛рж░рж╛: рзи:рзкрзй, рзи:рззрззрзж, рзи:рзирзнрзн | Surah Al-Baqarah)</span>
          </div>
        </div>

        <div style="background: white; padding: 10px; border-radius: 6px; border-left: 3px solid #16a34a; margin-bottom: 8px;">
          <div style="font-size: 10px; font-weight: 700; color: #166534; margin-bottom: 6px;">ЁЯУЪ рж╕рж╣рзАрж╣ рж╣рж╛ржжрзАрж╕ | Authentic Hadith:</div>
          <div style="font-size: 9px; color: #6b7280; line-height: 1.8;">
            <strong style="color: #15803d;">"рж░рзВржкрж╛рж░ ржирж┐рж╕рж╛ржм рзирзжрзж ржжрж┐рж░рж╣рж╛ржо (рзмрззрзи.рзйрзм ржЧрзНрж░рж╛ржо)"</strong><br/>
            <span style="font-style: italic;">(рж╕рж╣рзАрж╣ ржмрзБржЦрж╛рж░рзА: рззрзкрзлрзк | Sahih Bukhari: 1454)<br/>
            (рж╕рж╣рзАрж╣ ржорзБрж╕рж▓рж┐ржо: рзпрзнрзп | Sahih Muslim: 979)</span>
          </div>
        </div>

        <div style="background: white; padding: 10px; border-radius: 6px; border-left: 3px solid #16a34a;">
          <div style="font-size: 10px; font-weight: 700; color: #166534; margin-bottom: 6px;">тЪЦя╕П рж╣рж╛ржирж╛ржлрзА ржлрж┐ржХрж╣ | Hanafi Fiqh:</div>
          <div style="font-size: 9px; color: #6b7280; line-height: 1.8;">
            <strong style="color: #15803d;">рж░рзВржкрж╛ ржнрж┐рждрзНрждрж┐ржХ ржирж┐рж╕рж╛ржм (рзлрзи.рзл рждрзЛрж▓рж╛ = рзмрззрзи.рзйрзм ржЧрзНрж░рж╛ржо)</strong><br/>
            <span style="font-style: italic;">
            тАв рж░ржжрзНржжрзБрж▓ ржорзБрж╣рждрж╛рж░ (Raddul Muhtar)<br/>
            тАв ржЖрж▓-рж╣рж┐ржжрж╛ржпрж╝рж╛ (Al-Hidayah)<br/>
            тАв ржлрж╛рждрж╣рзБрж▓ ржХрж╝ржжрзАрж░ (Fathul Qadir)
            </span>
          </div>
        </div>
      </div>

      <!-- SPACING -->
      <div style="height: 15px;"></div>

      <!-- QR CENTERED -->
      <div style="text-align: center; margin: 25px auto; padding: 20px; background: white; border: 2px solid #e5e7eb; border-radius: 8px; max-width: 350px;">
        <div style="font-size: 12px; font-weight: 700; color: #1f2937; margin-bottom: 10px;">ЁЯФН ржпрж╛ржЪрж╛ржЗ ржХрж░рзБржи | Verify</div>
        <div style="display: inline-block;">
          <img src="${certQRCode}" style="width: 140px; height: 140px; border: 2px solid #e5e7eb; border-radius: 8px; padding: 8px; background: white;" />
        </div>
        <div style="font-size: 10px; color: #6b7280; margin-top: 10px;">QR ржХрзЛржб рж╕рзНржХрзНржпрж╛ржи ржХрж░рзЗ ржпрж╛ржЪрж╛ржЗ ржХрж░рзБржи</div>
        <div style="font-size: 9px; color: #9ca3af; margin-top: 6px; font-family: monospace; word-break: break-all; padding: 0 15px;">
          ${certificateId}
        </div>
      </div>

      <!-- Important Note -->
      <div style="background: #fffbeb; border: 2px solid #fbbf24; padding: 10px; border-radius: 8px; margin-bottom: 25px;">
        <div style="font-size: 12px; font-weight: 700; color: #92400e; margin-bottom: 8px;">тЪая╕П ржЧрзБрж░рзБрждрзНржмржкрзВрж░рзНржг ржирзЛржЯ | IMPORTANT NOTE</div>
        <div style="font-size: 9px; color: #78350f; line-height: 1.7; margin-bottom: 10px;">
          ржПржЗ рж╣рж┐рж╕рж╛ржм <strong>${localDate}</strong> рждрж╛рж░рж┐ржЦрзЗ BAJUS ржПрж░ рж░рзВржкрж╛рж░ ржмрж┐ржХрзНрж░ржпрж╝ ржорзВрж▓рзНржпрзЗрж░ ржЙржкрж░ ржнрж┐рждрзНрждрж┐ ржХрж░рзЗ рждрзИрж░рж┐ред<br/>
          Calculation Date: ${localDate}
        </div>
        <div style="background: white; padding: 8px; border-radius: 5px; border-left: 3px solid #fbbf24; font-size: 9px; color: #78350f;">
          тЪая╕П ржорзВрж▓рзНржп ржкрж░рж┐ржмрж░рзНрждржирж╢рзАрж▓ - ржпрж╛ржХрж╛ржд ржжрзЗржУржпрж╝рж╛рж░ ржЖржЧрзЗ рж╕рж░рзНржмрж╢рзЗрж╖ ржорзВрж▓рзНржп ржпрж╛ржЪрж╛ржЗ ржХрж░рзБржиред<br/>
          <span style="font-size: 8px;">Silver prices fluctuate daily. Please recheck current prices before paying.</span>
        </div>
      </div>

      <!-- SPACING -->
      <div style="height: 15px;"></div>

      <!-- Price + Final Confirmation -->
      <div style="margin-bottom: 40px;">
        <div style="background: white; border: 1px solid #e5e7eb; padding: 10px; border-radius: 6px; margin-bottom: 10px;">
          <div style="font-size: 10px; font-weight: 700; color: #1f2937; margin-bottom: 8px;">ЁЯТ░ ржорзВрж▓рзНржп ржпрж╛ржЪрж╛ржЗ | Price Verification:</div>
          <div style="font-size: 9px; color: #6b7280; line-height: 1.8;">
            ${countrySource.flag} ${countrySource.name}: ${countrySource.org}<br/>
            <strong>Website:</strong> ${countrySource.url}
          </div>
        </div>

        <div style="background: white; border: 1px solid #e5e7eb; padding: 10px; border-radius: 6px;">
          <div style="font-size: 10px; font-weight: 700; color: #1f2937; margin-bottom: 8px;">ЁЯТм ржЪрзВржбрж╝рж╛ржирзНржд ржирж┐рж╢рзНржЪрж┐рждржХрж░ржг | Final Confirmation:</div>
          <div style="font-size: 9px; color: #6b7280; line-height: 1.8;">
            - рж╕рзНржерж╛ржирзАржпрж╝ ржЖрж▓рзЗржо ржмрж╛ ржорзБржлрждрзАрж░ рж╕рж╛ржерзЗ ржкрж░рж╛ржорж░рзНрж╢ ржХрж░рзБржи<br/>
            - Consult with local Islamic scholars<br/>
            <div style="margin-top: 10px; padding: 8px; background: #f0fdf4; border-radius: 5px; font-weight: 600; color: #166534; border-left: 3px solid #16a34a;">
              ЁЯУз <strong>Muslim Finance Tracker Support:</strong><br/>
              support@muslimfinancetracker.com
            </div>
          </div>
        </div>
      </div>

      <!-- SPACING BEFORE FOOTER -->
      <div style="height: 25px;"></div>
    `);

    // ===== PAGE 4: MASAIL =====
    pages.push(`
      <div style="background: #fffbeb; border: 2px solid #fbbf24; padding: 9px; border-radius: 8px; margin-bottom: 9px;">
        <h2 style="font-size: 18px; font-weight: 700; color: #92400e; margin: 0; text-align: center;">
          ЁЯУЪ ржпрж╛ржХрж╛рждрзЗрж░ ржмрж┐рж╕рзНрждрж╛рж░рж┐ржд ржорж╛рж╕ржЖрж▓рж╛ | COMPLETE ZAKAT MASAIL
        </h2>
      </div>

      <div style="background: white; border: 1px solid #e5e7eb; padding: 10px; border-radius: 6px; margin-bottom: 9px;">
        <div style="font-size: 12px; font-weight: 700; color: #1f2937; margin-bottom: 10px; padding-bottom: 6px; border-bottom: 1px solid #e5e7eb;">
          рззред ржпрж╛ржХрж╛ржд ржлрж░ржп рж╣ржУржпрж╝рж╛рж░ рж╢рж░рзНрждрж╕ржорзВрж╣:
        </div>
        <div style="font-size: 10px; color: #4b5563; line-height: 1.9;">
          <strong>ржорж╛рж▓рж┐ржХрж╛ржирж╛:</strong> рж╕ржорзНржкржжрзЗрж░ ржкрзВрж░рзНржг ржорж╛рж▓рж┐ржХрж╛ржирж╛ ржерж╛ржХрждрзЗ рж╣ржмрзЗред<br/>
          <strong>ржирж┐рж╕рж╛ржм:</strong> ржирж┐рж╕рж╛ржм ржкрж░рж┐ржорж╛ржг рж╕ржорзНржкржж (рзлрзи.рзл рждрзЛрж▓рж╛ рж░рзВржкрж╛ ржмрж╛ рж╕ржорждрзБрж▓рзНржп)ред<br/>
          <strong>рж╣рж╛ржУрж▓:</strong> ржПржХ ржкрзВрж░рзНржг ржЪрж╛ржирзНржжрзНрж░ ржмржЫрж░ ржЕрждрж┐ржмрж╛рж╣рж┐ржд рж╣рждрзЗ рж╣ржмрзЗред<br/>
          <strong>ржорзМрж▓рж┐ржХ ржкрзНрж░ржпрж╝рзЛржЬржирзЗрж░ ржЕрждрж┐рж░рж┐ржХрзНржд:</strong> ржорзМрж▓рж┐ржХ ржкрзНрж░ржпрж╝рзЛржЬржи ржкрзВрж░ржгрзЗрж░ ржкрж░ ржЕрждрж┐рж░рж┐ржХрзНржд рж╕ржорзНржкржжред
        </div>
      </div>

      <div style="background: white; border: 1px solid #e5e7eb; padding: 10px; border-radius: 6px; margin-bottom: 9px;">
        <div style="font-size: 12px; font-weight: 700; color: #1f2937; margin-bottom: 10px; padding-bottom: 6px; border-bottom: 1px solid #e5e7eb;">
          рзиред ржпрж╛ржХрж╛рждржпрзЛржЧрзНржп рж╕ржорзНржкржж:
        </div>
        <div style="font-size: 10px; color: #4b5563; line-height: 1.9;">
          <strong>рж╕рзЛржирж╛ ржУ рж░рзВржкрж╛:</strong> ржмрж┐ржХрзНрж░ржпрж╝ ржорзВрж▓рзНржпрзЗ рж╣рж┐рж╕рж╛ржм (ржХрзНрж░ржпрж╝ ржорзВрж▓рзНржп ржерзЗржХрзЗ рж╕рж╛ржзрж╛рж░ржгржд рзирзж% ржХржо)ред<br/>
          <strong>ржиржЧржж ржЕрж░рзНрже:</strong> рж╣рж╛рждрзЗ ржмрж╛ ржмрзНржпрж╛ржВржХрзЗ ржерж╛ржХрж╛ рж╕ржХрж▓ ржЯрж╛ржХрж╛ред<br/>
          <strong>ржмрзНржпржмрж╕рж╛ржпрж╝рж┐ржХ ржкржгрзНржп:</strong> ржмрж░рзНрждржорж╛ржи ржмрж┐ржХрзНрж░ржпрж╝ ржорзВрж▓рзНржпрзЗ рж╣рж┐рж╕рж╛ржмред<br/>
          <strong>ржмрж┐ржирж┐ржпрж╝рзЛржЧ:</strong> рж╢рзЗржпрж╝рж╛рж░, ржмржирзНржб ржЗрждрзНржпрж╛ржжрж┐рж░ ржмрж░рзНрждржорж╛ржи ржорзВрж▓рзНржпред<br/>
          <strong>ржкрзНрж░ржжрждрзНржд ржЛржг:</strong> ржпрж╛ ржлрзЗрж░ржд ржкрж╛ржУржпрж╝рж╛рж░ рж╕ржорзНржнрж╛ржмржирж╛ ржЖржЫрзЗред
        </div>
      </div>

      <div style="background: white; border: 1px solid #e5e7eb; padding: 10px; border-radius: 6px; margin-bottom: 9px;">
        <div style="font-size: 12px; font-weight: 700; color: #1f2937; margin-bottom: 10px; padding-bottom: 6px; border-bottom: 1px solid #e5e7eb;">
          рзйред ржпрж╛ржХрж╛ржд ржкрж╛ржУржпрж╝рж╛рж░ ржпрзЛржЧрзНржп (рзо рж╢рзНрж░рзЗржгрзА):
        </div>
        <div style="font-size: 10px; color: #4b5563; line-height: 1.9;">
          рзз. <strong>ржлржХрзАрж░:</strong> ржпрж╛рж░ ржХрж┐ржЫрзБржЗ ржирзЗржЗ<br/>
          рзи. <strong>ржорж┐рж╕ржХрзАржи:</strong> ржпрж╛рж░ ржЕрж▓рзНржк ржЖржЫрзЗ ржХрж┐ржирзНрждрзБ ржкрзНрж░ржпрж╝рзЛржЬржи ржорзЗржЯрзЗ ржирж╛<br/>
          рзй. <strong>ржпрж╛ржХрж╛ржд ржХрж░рзНржоржЪрж╛рж░рзА</strong><br/>
          рзк. <strong>ржиржУ-ржорзБрж╕рж▓рж┐ржо</strong><br/>
          рзл. <strong>ржжрж╛рж╕ржорзБржХрзНрждрж┐</strong><br/>
          рзм. <strong>ржЛржгржЧрзНрж░рж╕рзНржд</strong><br/>
          рзн. <strong>ржЖрж▓рзНрж▓рж╛рж╣рж░ ржкржерзЗ</strong><br/>
          рзо. <strong>ржорзБрж╕рж╛ржлрж┐рж░</strong>
        </div>
      </div>

      <div style="background: #f0fdf4; border: 1px solid #16a34a; padding: 10px; border-radius: 6px; margin-bottom: 40px;">
        <div style="font-size: 12px; font-weight: 700; color: #166534; margin-bottom: 10px;">рзкред ржмрж┐рж╢рзЗрж╖ ржирзЛржЯ:</div>
        <div style="font-size: 10px; color: #166534; line-height: 1.9;">
          тАв ржирж┐ржЬрзЗрж░ рж╕рзНржмрж╛ржорзА/рж╕рзНрждрзНрж░рзА, ржкрж┐рждрж╛-ржорж╛рждрж╛, рж╕ржирзНрждрж╛ржиржХрзЗ ржпрж╛ржХрж╛ржд ржжрзЗржУржпрж╝рж╛ ржпрж╛ржпрж╝ ржирж╛ред<br/>
          тАв ржмрзНржпржХрзНрждрж┐ржЧржд ржмрзНржпржмрж╣рж╛рж░рзЗрж░ ржЬрж┐ржирж┐рж╕ (ржШрж░, ржЧрж╛ржбрж╝рж┐) ржпрж╛ржХрж╛рждржпрзЛржЧрзНржп ржиржпрж╝ред<br/>
          тАв ржЪрж╛ржирзНржжрзНрж░ ржмржЫрж░ рж╣рж┐рж╕рж╛ржмрзЗ ржПржХ ржмржЫрж░ ржкрзВрж░рзНржг рж╣рждрзЗ рж╣ржмрзЗред<br/>
          тАв <strong>ржмрж┐ржХрзНрж░ржпрж╝ ржорзВрж▓рзНржп</strong> ржжрж┐ржпрж╝рзЗ рж╣рж┐рж╕рж╛ржм ржХрж░рждрзЗ рж╣ржмрзЗ, ржХрзНрж░ржпрж╝ ржорзВрж▓рзНржп ржиржпрж╝ред
        </div>
      </div>
    `);

    // Generate PDF
    const pdf = new jsPDF('p', 'mm', 'a4');
    const totalPages = pages.length;
    console.log(`ЁЯУД Generating ${totalPages} PROFESSIONAL pages...`);

    for (let i = 0; i < pages.length; i++) {
      console.log(`  тЖТ Page ${i + 1}/${totalPages}...`);
      const pageContainer = createPage(pages[i], i + 1, totalPages);
      const canvas = await html2canvas(pageContainer, {
        scale: 2.5, useCORS: true, logging: false, backgroundColor: '#ffffff'
      });
      document.body.removeChild(pageContainer);
      if (i > 0) pdf.addPage();
      const imgData = canvas.toDataURL('image/png');
      pdf.addImage(imgData, 'PNG', 0, 0, 210, 297, '', 'FAST');
    }

    const fileName = `Zakat_Certificate_${date.replace(/\s/g, '_')}_${certificateId}.pdf`;
    pdf.save(fileName);
    
    console.log('тЬЕ CLEAN PROFESSIONAL certificate generated!');
    return { success: true, certificateId, fileName, pages: totalPages };

  } catch (error) {
    console.error('тЭМ Certificate generation error:', error);
    throw error;
  }
}
